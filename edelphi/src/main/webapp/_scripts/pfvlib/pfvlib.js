if((typeof fi)=="undefined"){var fi={}}if((typeof fi.metatavu)=="undefined"){fi.metatavu={}}if((typeof fi.metatavu.validation)=="undefined"){fi.metatavu.validation={}}if((typeof fi.metatavu.validation.validator)=="undefined"){fi.metatavu.validation.validator={}}fi.metatavu.validation.FieldValidator=Class.create({initialize:function(){},validate:function(a){},getType:function(){return null},getClassName:function(){},_getFieldValue:function(a){if(a.type=="checkbox"){return a.checked?"0":"1"}else{return a.value}}});Object.extend(fi.metatavu.validation.FieldValidator,{STATUS_UNDEFINED:-1,STATUS_UNKNOWN:0,STATUS_INVALID:1,STATUS_VALID:2,STATUS_HIDDEN:3,TYPE_NORMAL:0,TYPE_MANDATORY:1,TYPE_LINKED:2});fi.metatavu.validation.LinkedFieldValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super()},getLinkedField:function(a){},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_LINKED}});fi.metatavu.validation.FieldValidatorVault={initialize:function(){},registerValidator:function(a){this._validators.set(a.getClassName(),a)},getValidators:function(){return this._validators.values()},_validators:new Hash()};fi.metatavu.validation.ValidationDelegator=Class.create({initialize:function(a){this._field=a;this._fieldChangeListener=this._onFieldChange.bindAsEventListener(this);if(a.type=="checkbox"){Event.observe(a,"click",this._fieldChangeListener)}else{Event.observe(a,"keyup",this._fieldChangeListener);Event.observe(a,"change",this._fieldChangeListener)}this._validators=new Array()},deinitialize:function(){this._validators.clear();if(this._field.type=="checkbox"){Event.stopObserving(this._field,"click",this._fieldChangeListener)}else{Event.stopObserving(this._field,"keyup",this._fieldChangeListener);Event.stopObserving(this._field,"change",this._fieldChangeListener)}delete this._validators;this._validators=undefined;this._field=undefined},addValidator:function(a){this._validators.push(a)},validate:function(a){this._validate(a,this._validators,fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN)},forceValidate:function(a){this._field._validity=undefined;this.validate(a)},getStatus:function(){return this._field._validity==undefined?fi.metatavu.validation.FieldValidator.STATUS_UNDEFINED:this._field._validity},isMandatory:function(){for(var a=this._validators.length-1;a>=0;a--){if(this._validators[a].getType()==fi.metatavu.validation.FieldValidator.TYPE_MANDATORY){return true}}return false},insideForm:function(a){return this._field.form==a},_isVisible:function(){var a=$(this._field);if(a.getAttribute("type")=="hidden"){return false}while(a.parentNode){if(Object.isFunction(a.visible)&&!a.visible()){return false}a=$(a.parentNode)}return true},_validate:function(m,f,b){var j=this.getStatus();var h=b;var c=this._isVisible();if(c){for(var k=0,e=f.length;k<e;k++){if(h!=fi.metatavu.validation.FieldValidator.STATUS_INVALID){switch(f[k].validate(this._field)){case fi.metatavu.validation.FieldValidator.STATUS_INVALID:if(m&&(f[k].getType()==fi.metatavu.validation.FieldValidator.TYPE_MANDATORY)){h=fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN}else{h=fi.metatavu.validation.FieldValidator.STATUS_INVALID}break;case fi.metatavu.validation.FieldValidator.STATUS_VALID:h=fi.metatavu.validation.FieldValidator.STATUS_VALID;break}}else{break}}if(h!=fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN){var a=this._getLinkedValidators(f);for(var k=0,e=a.length;k<e;k++){var d=a[k].getLinkedField(this._field);var g=fi.metatavu.validation.ValidationDelegatorVault.getDelegator(d);g._linkedValidate(m,h,a[k])}}}else{h=fi.metatavu.validation.FieldValidator.STATUS_HIDDEN}if(j!=h){this._field._validity=h;switch(h){case fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN:if(j==fi.metatavu.validation.FieldValidator.STATUS_VALID){this._field.removeClassName("valid")}else{this._field.removeClassName("invalid")}__formValidationHook(this._field.form,this.isMandatory());break;case fi.metatavu.validation.FieldValidator.STATUS_INVALID:if(j==fi.metatavu.validation.FieldValidator.STATUS_VALID){this._field.removeClassName("valid")}this._field.addClassName("invalid");__formValidationHook(this._field.form,true);break;case fi.metatavu.validation.FieldValidator.STATUS_VALID:if(j!=fi.metatavu.validation.FieldValidator.STATUS_VALID){this._field.removeClassName("invalid")}this._field.addClassName("valid");__formValidationHook(this._field.form,false);break;case fi.metatavu.validation.FieldValidator.STATUS_HIDDEN:this._field.removeClassName("invalid");this._field.removeClassName("valid");__formValidationHook(this._field.form,false);break}}},_getLinkedValidators:function(c){var a=new Array();for(var e=0,b=c.length;e<b;e++){var d=c[e];if(d.getType()==fi.metatavu.validation.FieldValidator.TYPE_LINKED){a.push(d)}}return a},_linkedValidate:function(b,a,c){this._validate(b,this._validators.without(c),a)},_onFieldChange:function(a){this.validate(false)}});function __formValidationHook(f,a){if(f){f=$(f);var d=f.down(".formvalid");if(d){var g=!a;if(g){var c=fi.metatavu.validation.ValidationDelegatorVault.getFormDelegators(f);for(var e=0,b=c.length;e<b;e++){switch(c[e].getStatus()){case fi.metatavu.validation.FieldValidator.STATUS_INVALID:g=false;break;case fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN:if(c[e].isMandatory()){g=false}break}if(g==false){break}}}if(g){d.removeAttribute("disabled")}else{d.setAttribute("disabled","disabled")}}}}fi.metatavu.validation.ValidationDelegatorVault={initialize:function(){},getDelegator:function(a){return this._delegators.get(this._generateFieldName(a))},setDelegator:function(b,a){if(!this.getDelegator(b)){this._delegators.set(this._generateFieldName(b),a)}},releaseDelegator:function(b){var a=this.getDelegator(b);if(a){this._delegators.unset(this._generateFieldName(b));a.deinitialize();delete a}},getDelegators:function(){return this._delegators.values()},getFormDelegators:function(e){var b=new Array();var d=this.getDelegators();for(var c=0,a=d.length;c<a;c++){if(d[c].insideForm(e)){b.push(d[c])}}return b},_generateFieldName:function(a){return a.identify()},_delegators:new Hash()};function initializeValidation(b){var h=new Array();var n=$(b||document.body);var e=fi.metatavu.validation.FieldValidatorVault.getValidators();for(var g=0,d=e.length;g<d;g++){var k=n.select("."+e[g].getClassName());for(var f=0,a=k.length;f<a;f++){var o=k[f];var p=fi.metatavu.validation.ValidationDelegatorVault.getDelegator(o);if(!p){p=new fi.metatavu.validation.ValidationDelegator(o);fi.metatavu.validation.ValidationDelegatorVault.setDelegator(o,p)}p.addValidator(e[g]);h.push(p)}}var m=h.uniq();for(var g=0,d=m.length;g<d;g++){m[g].validate(true)}delete h;delete m}function initializeElementValidation(f){var c=fi.metatavu.validation.ValidationDelegatorVault.getDelegator(f);if(!c){c=new fi.metatavu.validation.ValidationDelegator(f);fi.metatavu.validation.ValidationDelegatorVault.setDelegator(f,c)}var b=fi.metatavu.validation.FieldValidatorVault.getValidators();for(var e=0,a=b.length;e<a;e++){var d=b[e];if(f.hasClassName(d.getClassName())){c.addValidator(d)}}c.validate(true)}function deinitializeValidation(b){var e=b||document.body;for(var d=0,a=e.childNodes.length;d<a;d++){if(e.childNodes[d].nodeType==1){deinitializeValidation(e.childNodes[d]);fi.metatavu.validation.ValidationDelegatorVault.releaseDelegator(e.childNodes[d])}}}function revalidateAll(d){var b=fi.metatavu.validation.ValidationDelegatorVault.getDelegators();for(var c=0,a=b.length;c<a;c++){b[c].validate(d)}}function forceRevalidateAll(d){var b=fi.metatavu.validation.ValidationDelegatorVault.getDelegators();for(var c=0,a=b.length;c<a;c++){b[c].forceValidate(d)}}Element.addMethods({validate:function(b,c,d){var a=fi.metatavu.validation.ValidationDelegatorVault.getDelegator(b);if(a){if(!d){a.validate(c)}else{a.forceValidate(c)}}}});fi.metatavu.validation.validator.EmailFieldValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super();this._validEmailMask=/^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/},validate:function($super,b){var a=this._getFieldValue(b);if(a){return this._validEmailMask.test(a.strip())?fi.metatavu.validation.FieldValidator.STATUS_VALID:fi.metatavu.validation.FieldValidator.STATUS_INVALID}else{return fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN}},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_NORMAL},getClassName:function(){return"email"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.EmailFieldValidator());fi.metatavu.validation.validator.EqualsFieldValidator=Class.create(fi.metatavu.validation.LinkedFieldValidator,{initialize:function($super){$super()},validate:function($super,d){var b=this.getLinkedField(d);if(b){var c=this._getFieldValue(d);var a=this._getFieldValue(b);if(c){return c==a?fi.metatavu.validation.FieldValidator.STATUS_VALID:fi.metatavu.validation.FieldValidator.STATUS_INVALID}}return fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN},getLinkedField:function(h){var c=$w(h.className);var g=h.form;for(var e=0,b=c.length;e<b;e++){if(c[e].startsWith("equals-")){var f=c[e].substring(7);if(g){var a=g[f];if(a){return a}}var d=document.getElementsByName(f);if(d.length==1){return d[0]}}}return null},getClassName:function(){return"equals"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.EqualsFieldValidator());fi.metatavu.validation.validator.FloatValidValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super();this._validFloatMask=/(^[-]?[0-9]+[,\.][0-9]+$)|(^[-]?[0-9]+$)/},validate:function($super,b){var a=this._getFieldValue(b);if(a){return this._validFloatMask.test(a)?fi.metatavu.validation.FieldValidator.STATUS_VALID:fi.metatavu.validation.FieldValidator.STATUS_INVALID}else{return fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN}},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_NORMAL},getClassName:function(){return"float"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.FloatValidValidator());fi.metatavu.validation.validator.MaskFieldValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super()},validate:function($super,c){var b=this._getFieldValue(c);var a=c.getAttribute("validatemask");if(a&&b){return new RegExp(a).test(b)?fi.metatavu.validation.FieldValidator.STATUS_VALID:fi.metatavu.validation.FieldValidator.STATUS_INVALID}else{return fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN}},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_NORMAL},getClassName:function(){return"mask"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.MaskFieldValidator());fi.metatavu.validation.validator.NumberValidValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super();this._validNumberMask=/^([-]?[0-9]*)$/},validate:function($super,b){var a=this._getFieldValue(b);if(a){return this._validNumberMask.test(a)?fi.metatavu.validation.FieldValidator.STATUS_VALID:fi.metatavu.validation.FieldValidator.STATUS_INVALID}else{return fi.metatavu.validation.FieldValidator.STATUS_UNKNOWN}},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_NORMAL},getClassName:function(){return"number"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.NumberValidValidator());fi.metatavu.validation.validator.RequiredFieldValidator=Class.create(fi.metatavu.validation.FieldValidator,{initialize:function($super){$super()},validate:function($super,a){return this._getFieldValue(a).blank()?fi.metatavu.validation.FieldValidator.STATUS_INVALID:fi.metatavu.validation.FieldValidator.STATUS_VALID},getType:function($super){return fi.metatavu.validation.FieldValidator.TYPE_MANDATORY},getClassName:function(){return"required"}});fi.metatavu.validation.FieldValidatorVault.registerValidator(new fi.metatavu.validation.validator.RequiredFieldValidator());